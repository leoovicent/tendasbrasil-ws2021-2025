// Generated by CoffeeScript 1.12.7 - Modified for scroll trigger, daily limit and session control
(function() {
  var SCROLL_THRESHOLD = 380;
  var STORAGE_KEY_DATE = 'uebb_popup_last_shown_date';
  var STORAGE_KEY_SESSION = 'uebb_popup_shown_session';

  // Helper: Obter data atual no formato YYYY-MM-DD
  function getTodayDate() {
    var now = new Date();
    var year = now.getFullYear();
    var month = String(now.getMonth() + 1).padStart(2, '0');
    var day = String(now.getDate()).padStart(2, '0');
    return year + '-' + month + '-' + day;
  }

  // Helper: Verificar se já foi exibido hoje
  function wasShownToday() {
    var lastShownDate = localStorage.getItem(STORAGE_KEY_DATE);
    return lastShownDate === getTodayDate();
  }

  // Helper: Verificar se já foi exibido nesta sessão
  function wasShownThisSession() {
    return sessionStorage.getItem(STORAGE_KEY_SESSION) === 'true';
  }

  // Helper: Marcar como exibido
  function markAsShown() {
    localStorage.setItem(STORAGE_KEY_DATE, getTodayDate());
    sessionStorage.setItem(STORAGE_KEY_SESSION, 'true');
  }

  // Helper: Bloquear scroll da página (preservando posição)
  function lockScroll() {
    var scrollY = window.scrollY || window.pageYOffset;
    document.body.style.top = '-' + scrollY + 'px';
    document.body.classList.add('uebb-popup-no-scroll');
  }

  // Helper: Desbloquear scroll da página (restaurando posição)
  function unlockScroll() {
    var scrollY = parseInt(document.body.style.top || '0', 10) * -1;
    document.body.classList.remove('uebb-popup-no-scroll');
    document.body.style.top = '';
    window.scrollTo(0, scrollY);
  }

  this.UebbPopup = new Vue({
    el: '#uebb-popup',
    data: {
      popup: {
        uebb_popup_link: {
          url: null
        }
      },
      opened: false,
      scrollHandler: null
    },
    mounted: function() {
      var _this = this;

      // Verificar se já foi exibido hoje OU nesta sessão
      if (wasShownToday() || wasShownThisSession()) {
        return;
      }

      // Criar handler de scroll
      this.scrollHandler = function() {
        if (window.scrollY >= SCROLL_THRESHOLD || window.pageYOffset >= SCROLL_THRESHOLD) {
          // Remover listener após atingir threshold
          window.removeEventListener('scroll', _this.scrollHandler);
          _this.scrollHandler = null;
          // Buscar e exibir popup
          _this.buscarPopup();
        }
      };

      // Adicionar listener de scroll
      window.addEventListener('scroll', this.scrollHandler);
    },
    watch: {
      // Observar mudanças no estado 'opened' para controlar scroll
      opened: function(newValue) {
        if (newValue) {
          lockScroll();
        } else {
          unlockScroll();
        }
      }
    },
    methods: {
      buscar: function(opts, callback) {
        var data, key, onError, onSuccess, value;
        if (opts == null) {
          opts = {};
        }
        if (callback == null) {
          callback = null;
        }
        onSuccess = function(response) {
          if (typeof callback === "function") {
            callback(response);
          }
        };
        onError = function(response) {
          console.error('Erro na requisição!');
        };
        data = {};
        for (key in opts) {
          value = opts[key];
          data[key] = value;
        }
        if (!data.action) {
          return;
        }
        $.ajax({
          type: 'POST',
          data: data,
          dataType: 'json',
          url: UebbPopupAssets.url,
          success: onSuccess
        }).fail(onError);
      },
      buscarPopup: function() {
        return this.buscar({
          action: 'uebb_popup_get_popups',
          nonce: UebbPopupAssets.nonce
        }, (function(_this) {
          return function(results) {
            var i, idx, len, listaPosts, meta, post, ref, ref1;
            if (!(results != null ? (ref = results.posts) != null ? ref.length : void 0 : void 0)) {
              return;
            }
            listaPosts = results.posts;
            idx = 0;
            if (listaPosts.length > 1) {
              idx = parseInt(Math.random() * listaPosts.length);
            }
            post = listaPosts[idx];
            post.idx = idx + 1;
            post.uebb_popup_imagem_url = '';
            ref1 = results.metas;
            for (i = 0, len = ref1.length; i < len; i++) {
              meta = ref1[i];
              if (meta.post_id === post.ID) {
                post[meta.meta_key] = meta.meta_value;
              }
            }

            // Marcar como exibido ANTES de mostrar
            markAsShown();

            if (post.uebb_popup_imagem) {
              _this.carregarImagem(post, function() {
                return _this.opened = true;
              });
            } else {
              _this.opened = true;
            }
            _this.popup = post;
          };
        })(this));
      },
      carregarImagem: function(post, callback) {
        var onError, onSuccess, url;
        if (callback == null) {
          callback = null;
        }
        if (!post.uebb_popup_imagem) {
          return;
        }
        onSuccess = function(response) {
          var ref, ref1, ref2;
          post.uebb_popup_imagem_url = (ref = response.media_details) != null ? (ref1 = ref.sizes) != null ? (ref2 = ref1.full) != null ? ref2.source_url : void 0 : void 0 : void 0;
          if (typeof callback === "function") {
            callback(response);
          }
        };
        onError = function(response) {
          console.error('Erro na requisição!');
        };
        url = uebbPopupConfig.host + "/wp-json/wp/v2/media/" + post.uebb_popup_imagem;
        $.ajax({
          type: 'GET',
          dataType: 'json',
          url: url,
          success: onSuccess
        }).fail(onError);
      },
      closePopup: function() {
        return this.opened = false;
      }
    }
  });

}).call(this);
